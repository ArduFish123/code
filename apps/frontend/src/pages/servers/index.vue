<template>
  <div data-pyro class="servers-hero relative -mt-48 h-full min-h-screen py-48 md:-mt-20 md:py-32">
    <!-- TODO: redirect to server url (/servers/manage/:id) -->
    <PurchaseModal
      v-if="showModal && selectedProduct && customer"
      :key="selectedProduct.id"
      ref="purchaseModal"
      :product="selectedProduct"
      :country="country"
      :publishable-key="config.public.stripePublishableKey"
      :send-billing-request="
        async (body) =>
          await useBaseFetch('billing/payment', { internal: true, method: 'POST', body })
      "
      :fetch-payment-data="fetchPaymentData"
      :on-error="handleError"
      :customer="customer"
      :payment-methods="paymentMethods"
      :return-url="`${config.public.siteUrl}/servers/manage`"
      @hidden="handleModalHidden"
    />
    <img
      src="~/assets/images/games/maze.png"
      alt=""
      aria-hidden="true"
      class="pointer-events-none absolute inset-0 h-full max-h-[1080px] w-screen scale-125 select-none opacity-50"
      style="mask-image: linear-gradient(black, transparent 80%)"
    />

    <section class="relative mx-auto flex max-w-7xl flex-col px-3">
      <div class="flex w-full flex-col gap-10">
        <div
          class="relative w-fit rounded-full bg-highlight-green px-3 py-1 text-sm font-bold text-brand backdrop-blur-lg"
        >
          Experimental
        </div>
        <h1 class="relative m-0 max-w-2xl text-4xl leading-[120%] md:text-7xl">
          Play together on Modrinth Servers
        </h1>
        <h2
          class="relative m-0 max-w-2xl text-base font-normal leading-[155%] text-secondary md:text-[1.2rem]"
        >
          Start your own Minecraft server directly on Modrinth. Play your favorite mods, plugins,
          and datapacks with friends â€” without the hassle of setup.
        </h2>
        <div class="relative flex w-fit flex-row gap-8">
          <!--
            Open modal, choose plan
            Choose modpack (redirect to search page) - or choose a loader (forge/fabric/vanilla) with no mods
            Mount stripe
            On success, create server and redirect user to management page
          -->
          <ButtonStyled color="brand" size="large">
            <nuxt-link class="w-fit" to="#plan"> Start your server </nuxt-link>
          </ButtonStyled>
          <UiServersPoweredByPyro class="!mt-0" />
        </div>

        <div
          class="pointer-events-none relative flex h-full w-full flex-row items-end gap-24 md:-mt-24"
        >
          <div
            class="absolute left-0 right-0 top-0 max-h-[80%] overflow-hidden"
            style="mask-image: linear-gradient(black, transparent 80%)"
          >
            <img
              src="~/assets/images/games/rinth.png"
              alt=""
              aria-hidden="true"
              class="pointer-events-none w-full animate-spin select-none pt-8 opacity-50"
              style="
                animation-duration: 128s !important;
                animation-timing-function: linear;
                animation-iteration-count: infinite;
              "
            />
          </div>
          <img
            src="~/assets/images/games/servers-hero-real-noshadow.png"
            alt=""
            class="relative mt-8 h-full w-full rounded-3xl object-cover md:w-[55%]"
          />
          <div class="relative hidden w-[45%] md:block">
            <img
              src="~/assets/images/games/combined-hero.png"
              alt=""
              class="relative w-full rounded-3xl object-fill"
            />
          </div>
        </div>
      </div>
    </section>

    <section
      class="relative mt-24 flex flex-col bg-[radial-gradient(65%_50%_at_50%_-10%,var(--color-brand-highlight)_0%,var(--color-accent-contrast)_100%)] px-3 pt-24 md:mt-48 md:pt-48"
    >
      <div class="faded-brand-line absolute top-0 h-[1px] w-full"></div>
      <div class="relative mx-auto flex w-full max-w-7xl flex-col gap-8">
        <div
          class="relative w-fit rounded-full bg-highlight-green px-3 py-1 text-sm font-bold text-brand backdrop-blur-lg"
        >
          Why Modrinth Servers?
        </div>
        <h1 class="relative m-0 max-w-2xl text-4xl leading-[120%] md:text-7xl">
          Make a modpack. Now it's a server.
        </h1>
        <h2
          class="relative m-0 max-w-2xl text-base font-normal leading-[155%] text-secondary md:text-[18px]"
        >
          Integrated with Modrinth App. Choose from thousands of modpacks or create your own from
          your profiles. Invite your friends when you're ready to play.
        </h2>
        <img
          src="~/assets/images/games/excitement.png"
          alt=""
          class="absolute right-8 top-0 hidden max-w-[360px] lg:block"
        />
        <div class="relative grid w-full grid-cols-1 gap-8 lg:grid-cols-2">
          <div class="relative flex flex-col gap-4 rounded-2xl bg-bg p-6 text-left md:p-12">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="size-8 text-brand"
            >
              <path
                d="M8.3 10a.7.7 0 0 1-.626-1.079L11.4 3a.7.7 0 0 1 1.198-.043L16.3 8.9a.7.7 0 0 1-.572 1.1Z"
              />
              <rect x="3" y="14" width="7" height="7" rx="1" />
              <circle cx="17.5" cy="17.5" r="3.5" />
            </svg>
            <h2 class="m-0 text-lg font-bold">Play where your mods are</h2>
            <h3 class="m-0 text-base font-normal text-secondary">
              Experience a seamless integration between your mods and your servers. Modpacks install
              within seconds and run without a hitch.
            </h3>
          </div>

          <div class="relative flex flex-col gap-4 rounded-2xl bg-bg p-6 text-left md:p-12">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="size-8 text-brand"
            >
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
              <circle cx="9" cy="7" r="4" />
              <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
              <path d="M16 3.13a4 4 0 0 1 0 7.75" />
            </svg>
            <h2 class="m-0 text-lg font-bold">Join with a single click</h2>
            <h3 class="m-0 text-base font-normal text-secondary">
              Your servers are sharable with just one link. Easily invite your friends to join your
              server. Modrinth takes care of installing the mods.
            </h3>
          </div>
        </div>
        <div class="relative">
          <img
            src="~/assets/images/games/servers-hero-square-fixed-forreal-updated.png"
            alt=""
            class="w-full rounded-2xl"
          />
        </div>
        <div class="grid w-full grid-cols-1 gap-8 lg:grid-cols-2">
          <div class="flex flex-col gap-4 rounded-2xl bg-bg p-6 text-left md:p-12">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="size-8 text-brand"
            >
              <rect width="20" height="16" x="2" y="4" rx="2" />
              <path d="M6 8h.01" />
              <path d="M10 8h.01" />
              <path d="M14 8h.01" />
            </svg>
            <h2 class="m-0 text-lg font-bold">Manage it all on Modrinth</h2>
            <h3 class="m-0 text-base font-normal text-secondary">
              Manage your server, mods, and players all in one place. No need to switch between
              different platforms just to play.
            </h3>
          </div>

          <div class="relative flex flex-col gap-4 rounded-2xl bg-bg p-6 text-left md:p-12">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="size-8 text-brand"
            >
              <polygon points="13 19 22 12 13 5 13 19" />
              <polygon points="2 19 11 12 2 5 2 19" />
            </svg>
            <h2 class="m-0 text-lg font-bold">Play on the fastest servers in the world</h2>
            <h3 class="m-0 text-base font-normal text-secondary">
              Modrinth Servers are hosted on the fastest, most reliable infrastructure using
              custom-built software built by Pyro.
            </h3>
          </div>
        </div>
      </div>
    </section>

    <section
      class="relative mt-24 flex flex-col bg-[radial-gradient(65%_50%_at_50%_-10%,var(--color-brand-highlight)_0%,var(--color-accent-contrast)_100%)] px-3 pt-24 md:mt-48 md:pt-48"
    >
      <div class="faded-brand-line absolute top-0 h-[1px] w-full"></div>
      <div class="relative mx-auto flex w-full max-w-7xl flex-col gap-8">
        <div
          class="relative w-fit rounded-full bg-highlight-green px-3 py-1 text-sm font-bold text-brand backdrop-blur-lg"
        >
          Included with your server
        </div>
        <h1 class="relative m-0 max-w-2xl text-4xl leading-[120%] md:text-7xl">
          All the features you need
        </h1>
        <h2
          class="relative m-0 max-w-xl text-base font-normal leading-[155%] text-secondary md:text-[18px]"
        >
          Included with every server is a suite of features designed to provide a hosting experience
          that only Modrinth can offer.
        </h2>
        <img
          src="~/assets/images/games/waving.png"
          alt=""
          class="absolute right-8 top-32 hidden max-w-[580px] lg:block"
        />
        <div class="grid grid-cols-1 gap-9 lg:grid-cols-2">
          <div class="grid w-full grid-cols-1 gap-8">
            <div class="relative flex flex-col gap-4 rounded-2xl bg-bg p-6 text-left md:p-12">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="size-8 text-brand"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" />
                <path d="M2 12h20" />
              </svg>
              <h2 class="m-0 text-lg font-bold">Custom URL</h2>
              <h3 class="m-0 text-base font-normal text-secondary">
                Share your server with a custom
                <span class="text-contrast">modrinth.gg</span> URL.
              </h3>
              <div
                aria-hidden="true"
                class="ooh-shiny absolute right-4 top-4 flex items-center justify-center rounded-full bg-bg-raised p-4"
              >
                <span class="font-bold text-contrast">{{ currentText }}</span
                >.modrinth.gg
              </div>
            </div>
            <div class="relative flex flex-col gap-4 rounded-2xl bg-bg p-6 text-left md:p-12">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="size-8 text-brand"
              >
                <path d="M12 13v8" />
                <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" />
                <path d="m8 17 4-4 4 4" />
              </svg>
              <h2 class="m-0 text-lg font-bold">Backups included</h2>
              <h3 class="m-0 text-base font-normal text-secondary">
                Back up your server up to 15 times and keep your data stored forever.
              </h3>
            </div>
          </div>
          <div
            class="relative flex flex-col gap-4 overflow-hidden rounded-2xl bg-highlight p-6 text-left backdrop-blur-xl md:p-12"
          >
            <h2 class="m-0 text-lg font-bold">Unlimited storage</h2>
            <h3 class="m-0 text-base font-normal">
              Store as many mods, plugins, and worlds as you need.
            </h3>

            <img
              src="~/assets/images/games/content-hero.png"
              alt=""
              class="absolute -bottom-16 -right-[15%] max-w-2xl rounded-2xl bg-brand p-4"
            />
            <div
              aria-hidden="true"
              class="absolute bottom-8 right-8 rounded-full bg-brand p-4 text-sm font-bold text-[var(--color-accent-contrast)]"
            >
              8.49 GB used
            </div>
          </div>
        </div>
        <div class="relative flex flex-col gap-4 rounded-2xl bg-bg p-6 text-left md:p-12">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="size-8 text-brand"
          >
            <path
              d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"
            />
            <path
              d="M12 5 9.04 7.96a2.17 2.17 0 0 0 0 3.08c.82.82 2.13.85 3 .07l2.07-1.9a2.82 2.82 0 0 1 3.79 0l2.96 2.66"
            />
            <path d="m18 15-2-2" />
            <path d="m15 18-2-2" />
          </svg>
          <h2 class="m-0 text-lg font-bold">Help when you need it</h2>
          <h3 class="m-0 text-base font-normal text-secondary">
            Reach out to the Modrinth team for help with your server at any time.
          </h3>
        </div>
      </div>
    </section>

    <section
      id="plan"
      class="relative mt-24 flex flex-col bg-[radial-gradient(65%_50%_at_50%_-10%,var(--color-brand-highlight)_0%,var(--color-accent-contrast)_100%)] px-3 pt-24 md:mt-48 md:pt-48"
    >
      <div class="faded-brand-line absolute top-0 h-[1px] w-full"></div>
      <div class="mx-auto flex w-full max-w-7xl flex-col items-center gap-8 text-center">
        <h1 class="relative m-0 text-4xl leading-[120%] md:text-7xl">
          Start your server on Modrinth
        </h1>
        <h2
          class="relative m-0 max-w-xl text-base font-normal leading-[155%] text-secondary md:text-[18px]"
        >
          Choose the plan that's right for your server.
        </h2>

        <ul class="m-0 flex w-full flex-col gap-8 p-0 md:flex-row">
          <li
            v-for="product in pyroProducts"
            :key="product.id"
            :class="[
              'm-0 flex w-full list-none flex-col gap-6 rounded-2xl p-8 text-left',
              product.metadata.ram === 6144 ? 'bg-highlight' : 'bg-bg',
            ]"
          >
            <div
              role="heading"
              aria-level="2"
              class="-mb-4 text-sm"
              :class="{ 'text-contrast': product.metadata.ram === 6144 }"
            >
              {{ getProductSize(product) }}
            </div>
            <div class="flex flex-row items-end">
              <div class="text-5xl font-bold text-contrast">
                {{
                  formatPrice(
                    vintl.locale,
                    getProductPrice(product).prices.intervals.monthly,
                    getProductPrice(product).currency_code,
                  )
                }}
              </div>
              <div class="text-secondary">/month</div>
            </div>
            <div>{{ product.metadata.ram / 1024 }} GB RAM</div>
            <div
              class="h-[1px] w-full"
              :class="product.metadata.ram === 6144 ? 'bg-brand opacity-50' : 'bg-bg-raised'"
            ></div>
            <p class="m-0" :class="{ 'text-contrast': product.metadata.ram === 6 }">
              {{ getProductDescription(product) }}
            </p>
            <ButtonStyled
              :color="product.metadata.ram === 6144 ? 'brand' : 'standard'"
              size="large"
            >
              <button @click="selectProduct(product)">
                {{ product.metadata.ram === 6144 ? "Start your server" : "Select plan" }}
              </button>
            </ButtonStyled>
          </li>
        </ul>
      </div>
    </section>
  </div>
</template>

<script setup>
import { ref, onMounted, onUnmounted, watch, nextTick } from "vue";
import { ButtonStyled, PurchaseModal } from "@modrinth/ui";
import { formatPrice, getCurrency } from "@modrinth/utils";
import { products } from "~/generated/state.json";

const title = "Modrinth Servers";
const description =
  "Start your own Minecraft server directly on Modrinth. Play your favorite mods, plugins, and datapacks â€” without the hassle of setup.";

useSeoMeta({
  title,
  description,
  ogTitle: title,
  ogDescription: description,
});

useHead({
  script: [
    {
      src: "https://js.stripe.com/v3/",
      defer: true,
      async: true,
    },
  ],
});

const auth = await useAuth();
const vintl = useVIntl();
const data = useNuxtApp();
const config = useRuntimeConfig();
const purchaseModal = ref(null);
const country = useUserCountry();
const customer = ref(null);
const paymentMethods = ref([]);
const selectedProduct = ref(null);
const showModal = ref(false);
const modalKey = ref(0);

const pyroProducts = products.filter((p) => p.metadata.type === "pyro");
pyroProducts.sort((a, b) => a.metadata.ram - b.metadata.ram);

const getProductSize = (product) => {
  const ramSize = parseInt(product.metadata.ram);
  if (ramSize === 4096) return "Small";
  if (ramSize === 6144) return "Medium";
  if (ramSize === 8192) return "Large";
  return "Custom";
};

const getProductPrice = (product) => {
  // fallback to us
  return (
    product.prices.find((p) => p.currency_code === getCurrency(country.value)) ??
    product.prices.find((p) => p.currency_code === "USD") ??
    product.prices[0]
  );
};

const getProductDescription = (product) => {
  const ramSize = parseInt(product.metadata.ram);
  if (ramSize === 4096)
    return "Perfect for small modpacks and friend groups looking to play together.";
  if (ramSize === 6144)
    return "The best value for most players. Add more mods and friends to your server with ease.";
  if (ramSize === 8192) return "For the biggest modpacks. Play with hundreds of mods at once.";
  return "Custom server configuration.";
};

const selectProduct = async (product) => {
  if (!auth.value.user) {
    data.$router.push("/auth/sign-in");
    return;
  }
  selectedProduct.value = product;
  showModal.value = true;
  modalKey.value++;
  await nextTick();
  if (purchaseModal.value && purchaseModal.value.show) {
    purchaseModal.value.show();
  }
};

const handleError = (err) => {
  data.$notify({
    group: "main",
    title: "An error occurred",
    type: "error",
    text: err.message ?? (err.data ? err.data.description : err),
  });
};

const handleModalHidden = () => {
  showModal.value = false;
};

watch(selectedProduct, async (newProduct) => {
  if (newProduct) {
    showModal.value = false;
    await nextTick();
    showModal.value = true;
    modalKey.value++;
    await nextTick();
    if (purchaseModal.value && purchaseModal.value.show) {
      purchaseModal.value.show();
    }
  }
});

async function fetchPaymentData() {
  if (!auth.value.user) return;
  try {
    const [customerData, paymentMethodsData] = await Promise.all([
      useBaseFetch("billing/customer", { internal: true }),
      useBaseFetch("billing/payment_methods", { internal: true }),
    ]);
    customer.value = customerData;
    paymentMethods.value = paymentMethodsData;
  } catch (error) {
    console.error("Error fetching payment data:", error);
    data.$notify({
      group: "main",
      title: "Error fetching payment data",
      type: "error",
      text: error.message || "An unexpected error occurred",
    });
  }
}

const words = ["friends", "medieval-masters", "create-server", "mega-smp", "spookypack"];
const currentWordIndex = ref(0);
const currentText = ref("");
const isDeleting = ref(false);
const typingSpeed = 75;
const deletingSpeed = 25;
const pauseTime = 2000;

const startTyping = () => {
  const currentWord = words[currentWordIndex.value];
  if (isDeleting.value) {
    if (currentText.value.length > 0) {
      currentText.value = currentText.value.slice(0, -1);
      setTimeout(startTyping, deletingSpeed);
    } else {
      isDeleting.value = false;
      currentWordIndex.value = (currentWordIndex.value + 1) % words.length;
      setTimeout(startTyping, typingSpeed);
    }
  } else if (currentText.value.length < currentWord.length) {
    currentText.value = currentWord.slice(0, currentText.value.length + 1);
    setTimeout(startTyping, typingSpeed);
  } else {
    isDeleting.value = true;
    setTimeout(startTyping, pauseTime);
  }
};

onMounted(() => {
  document.body.style.background = "var(--color-accent-contrast)";
  const layoutDiv = document.querySelector(".layout");
  if (layoutDiv) {
    layoutDiv.style.background = "var(--color-accent-contrast)";
  }
  startTyping();
  fetchPaymentData();
});

onUnmounted(() => {
  document.body.style.background = "";
  const layoutDiv = document.querySelector(".layout");
  if (layoutDiv) {
    layoutDiv.style.background = "";
  }
});

watch(selectedProduct, async (newProduct) => {
  if (newProduct) {
    showModal.value = false;
    await nextTick();
    showModal.value = true;
    await nextTick();
    if (purchaseModal.value && purchaseModal.value.show) {
      purchaseModal.value.show();
    }
  }
});
</script>

<style scoped>
.servers-hero {
  background: radial-gradient(
    65% 30% at 50% -10%,
    var(--color-brand-highlight) 0%,
    var(--color-accent-contrast) 100%
  );
}

.faded-brand-line {
  background: linear-gradient(to right, var(--color-brand-highlight), transparent);
}
</style>
